<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>培训服务 - 留学服务平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/style.css">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="../../index.html">留学服务平台</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">仪表盘</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="school-recommendation.html">选校推荐</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="school-search.html">学校搜索</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="success-cases.html">成功案例</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="training-service.html">培训服务</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="document-service.html">文书服务</a>
                    </li>
                </ul>
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span id="username-display">用户名</span>
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="profile.html">个人信息</a>
                            <a class="dropdown-item" href="javascript:void(0);" id="logout-btn">退出登录</a>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主体内容 -->
    <div class="container mt-5">
        <h2>语言培训服务</h2>
        
        <!-- 预约服务表单 -->
        <div class="card mt-4">
            <div class="card-header bg-primary text-white">
                <h4>预约培训服务</h4>
            </div>
            <div class="card-body">
                <form id="reservation-form" class="needs-validation" novalidate>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="training-hours" class="form-label">总课时</label>
                            <select class="form-select" id="training-hours" required>
                                <option value="">请选择课时</option>
                                <option value="10">10课时</option>
                                <option value="20">20课时</option>
                                <option value="30">30课时</option>
                                <option value="50">50课时</option>
                                <option value="100">100课时</option>
                            </select>
                            <div class="invalid-feedback">请选择课时</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="training-type" class="form-label">培训类型</label>
                            <select class="form-select" id="training-type" required>
                                <option value="">请选择培训类型</option>
                                <option value="toefl">托福</option>
                                <option value="gre">GRE</option>
                                <option value="ielts">雅思</option>
                                <option value="sat">SAT</option>
                                <option value="other">其他</option>
                            </select>
                            <div class="invalid-feedback">请选择培训类型</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="teacher-select" class="form-label">选择教师</label>
                            <select class="form-select" id="teacher-select" required>
                                <option value="">请选择教师</option>
                                <!-- 教师列表会通过API动态加载 -->
                            </select>
                            <div class="invalid-feedback">请选择教师</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="training-notes" class="form-label">备注</label>
                            <textarea class="form-control" id="training-notes" rows="3" placeholder="请输入您的特殊需求或偏好"></textarea>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-12 text-center">
                            <button type="submit" class="btn btn-primary btn-lg">提交预约</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 预约列表 -->
        <div class="card mt-5">
            <div class="card-header bg-success text-white">
                <h4>我的预约列表</h4>
            </div>
            <div class="card-body">
                <div id="reservations-container">
                    <div class="text-center py-5">
                        <p class="text-muted">正在加载预约记录...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 查看详情模态框 -->
    <div class="modal fade" id="viewDetailModal" tabindex="-1" role="dialog" aria-labelledby="viewDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewDetailModalLabel">预约详情</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="modal-body-content">
                    <!-- 详情内容会动态填充 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../../js/common.js"></script>
    <script>
        // 检查登录状态
        checkLogin();
        
        // 退出登录
        document.getElementById('logout-btn').addEventListener('click', () => {
            logout();
            window.location.href = '../../index.html';
        });
        
        // 加载教师列表
        async function loadTeachers() {
            try {
                // 这里应该调用获取教师列表的API
                // 由于是模拟环境，我们使用模拟数据
                const teachers = [
                    { id: 1, name: '张老师', specialty: '托福阅读与写作' },
                    { id: 2, name: '李老师', specialty: 'GRE数学' },
                    { id: 3, name: '王老师', specialty: '雅思口语' },
                    { id: 4, name: '刘老师', specialty: 'SAT全科' }
                ];
                
                const teacherSelect = document.getElementById('teacher-select');
                teachers.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.id;
                    option.textContent = `${teacher.name} (${teacher.specialty})`;
                    teacherSelect.appendChild(option);
                });
            } catch (error) {
                console.error('加载教师列表失败:', error);
            }
        }
        
        // 表单提交处理
        document.getElementById('reservation-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const form = e.target;
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }
            
            const trainingHours = document.getElementById('training-hours').value;
            const trainingType = document.getElementById('training-type').value;
            const teacherId = document.getElementById('teacher-select').value;
            const notes = document.getElementById('training-notes').value;
            
            try {
                // 适配后端的请求参数格式
                const requestData = {
                    total_hours: parseInt(trainingHours),
                    teacher_id: parseInt(teacherId)
                };
                
                // 如果后端支持这些字段，也发送
                if (trainingType) requestData.training_type = trainingType;
                if (notes) requestData.notes = notes;
                
                const response = await apiClient.post('/student/training/reserve', requestData);
                
                alert('预约提交成功！');
                form.reset();
                form.classList.remove('was-validated');
                
                // 重新加载预约列表
                loadReservations();
            } catch (error) {
                console.error('提交预约失败:', error);
                alert('预约提交失败，请稍后重试');
            }
        });
        
        // 加载预约列表
        async function loadReservations() {
            try {
                const response = await apiClient.get('/student/training/list');
                const reservations = response.data;
                
                const container = document.getElementById('reservations-container');
                
                if (reservations.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <p class="text-muted">暂无培训预约记录</p>
                        </div>
                    `;
                    return;
                }
                
                // 生成预约列表HTML
                let html = `
                    <table class="table table-bordered table-hover">
                        <thead class="thead-light">
                            <tr>
                                <th>预约编号</th>
                                <th>培训类型</th>
                                <th>总课时</th>
                                <th>任课教师</th>
                                <th>预约时间</th>
                                <th>状态</th>
                                <th>已上课时</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                reservations.forEach(reservation => {
                        // 状态样式
                        let statusClass = 'badge-secondary';
                        statusText = '未知';
                        
                        switch(reservation.status) {
                            case 'pending':
                                statusClass = 'badge-warning';
                                statusText = '待受理';
                                break;
                            case 'accepted':
                                statusClass = 'badge-info';
                                statusText = '已受理';
                                break;
                            case 'completed':
                                statusClass = 'badge-success';
                                statusText = '已完成';
                                break;
                            case 'rejected':
                                statusClass = 'badge-danger';
                                statusText = '已拒绝';
                                break;
                        }
                        
                        html += `
                            <tr>
                                <td>${reservation.id}</td>
                                <td>${getTrainingTypeText(reservation.training_type || 'language')}</td>
                                <td>${reservation.total_hours || reservation.training_hours || 0}课时</td>
                                <td>${reservation.teacher_name || '未分配'}</td>
                                <td>${formatDate(reservation.created_at)}</td>
                                <td><span class="badge ${statusClass}">${statusText}</span></td>
                                <td>${reservation.attended_hours || reservation.completed_hours || 0}/${reservation.total_hours || reservation.training_hours || 0}</td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="viewReservationDetail(${reservation.id})">
                                        查看详情
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                container.innerHTML = html;
            } catch (error) {
                console.error('获取预约列表失败:', error);
                document.getElementById('reservations-container').innerHTML = `
                    <div class="text-center py-5">
                        <p class="text-danger">加载预约记录失败，请稍后重试</p>
                    </div>
                `;
            }
        }
        
        // 查看预约详情
        async function viewReservationDetail(reservationId) {
            try {
                const response = await apiClient.get(`/student/training/detail?id=${reservationId}`);
                const reservation = response.data;
                
                // 生成详情HTML
                const modalBody = document.getElementById('modal-body-content');
                
                modalBody.innerHTML = `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>预约编号：</strong>${reservation.id}</p>
                            <p><strong>培训类型：</strong>${getTrainingTypeText(reservation.training_type || 'language')}</p>
                            <p><strong>总课时：</strong>${reservation.total_hours || reservation.training_hours || 0}课时</p>
                            <p><strong>已上课时：</strong>${reservation.attended_hours || reservation.completed_hours || 0}课时</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>任课教师：</strong>${reservation.teacher_name || '未分配'}</p>
                            <p><strong>预约时间：</strong>${formatDate(reservation.created_at)}</p>
                            <p><strong>状态：</strong>${getStatusText(reservation.status)}</p>
                            <p><strong>更新时间：</strong>${reservation.updated_at ? formatDate(reservation.updated_at) : '-'}</p>
                        </div>
                    </div>
                    ${reservation.notes ? `<div class="mb-3"><strong>备注：</strong>${reservation.notes}</div>` : ''}
                    ${reservation.feedback ? `<div class="mb-3"><strong>教师反馈：</strong>${reservation.feedback}</div>` : ''}
                    ${reservation.homework ? `<div class="mb-3"><strong>作业安排：</strong>${reservation.homework}</div>` : ''}
                `;
                
                // 显示模态框（使用原生JavaScript替代jQuery）
                const modal = new bootstrap.Modal(document.getElementById('viewDetailModal'));
                modal.show();
            } catch (error) {
                console.error('获取预约详情失败:', error);
                alert('加载详情失败，请稍后重试');
            }
        }
        
        // 辅助函数：获取培训类型文本
        function getTrainingTypeText(type) {
            const types = {
                'toefl': '托福',
                'gre': 'GRE',
                'ielts': '雅思',
                'sat': 'SAT',
                'other': '其他'
            };
            return types[type] || type;
        }
        
        // 辅助函数：获取状态文本
        function getStatusText(status) {
            const statuses = {
                'pending': '待受理',
                'accepted': '已受理',
                'completed': '已完成',
                'rejected': '已拒绝'
            };
            return statuses[status] || '未知';
        }
        
        // 辅助函数：格式化日期
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }
        
        // 页面加载时初始化
        window.addEventListener('DOMContentLoaded', () => {
            // 检查登录状态
            if (!checkLogin()) return;
            
            // 检查角色权限
            const role = getUserRole();
            if (role !== 'student') {
                alert('您没有权限访问此页面');
                window.location.href = '../../index.html';
                return;
            }
            
            // 设置用户名显示
            const username = getUsername();
            if (username) {
                document.getElementById('username-display').textContent = username;
            }
            
            // 加载数据
            loadTeachers();
            loadReservations();
        });
    </script>
</body>
</html>