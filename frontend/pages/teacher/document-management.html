<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文书管理 - 留学服务平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/style.css">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="../../index.html">留学服务平台</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">仪表盘</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="training-management.html">培训管理</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="document-management.html">文书管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="student-statistics.html">学生统计</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="school-management.html">学校管理</a>
                    </li>
                </ul>
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span id="username-display">用户名</span>
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="profile.html">个人信息</a>
                            <a class="dropdown-item" href="javascript:void(0);" id="logout-btn">退出登录</a>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主体内容 -->
    <div class="container mt-5">
        <h2>文书服务管理</h2>
        
        <!-- 筛选条件 -->
        <div class="card mt-4">
            <div class="card-header">
                <h4>筛选条件</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="document-status-filter" class="form-label">文书状态</label>
                        <select class="form-select" id="document-status-filter">
                            <option value="">全部</option>
                            <option value="pending">待受理</option>
                            <option value="accepted">已受理</option>
                            <option value="processing">处理中</option>
                            <option value="completed">已完成</option>
                            <option value="rejected">已拒绝</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="document-student-filter" class="form-label">学生姓名</label>
                        <input type="text" class="form-control" id="document-student-filter" placeholder="输入学生姓名">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="document-type-filter" class="form-label">文书类型</label>
                        <select class="form-select" id="document-type-filter">
                            <option value="">全部</option>
                            <option value="personal_statement">个人陈述(PS)</option>
                            <option value="sop">目的陈述(SOP)</option>
                            <option value="letter_of_recommendation">推荐信</option>
                            <option value="cv">简历</option>
                            <option value="essay">小作文</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 text-right">
                        <button class="btn btn-primary" id="document-filter-btn">筛选</button>
                        <button class="btn btn-secondary ml-2" id="document-reset-filter-btn">重置</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 文书列表 -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h4>文书预约列表</h4>
            </div>
            <div class="card-body">
                <div id="document-list-container">
                    <div class="text-center py-5">
                        <p class="text-muted">正在加载文书预约记录...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 文书详情与处理模态框 -->
    <div class="modal fade" id="documentDetailModal" tabindex="-1" role="dialog" aria-labelledby="documentDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="documentDetailModalLabel">文书预约详情</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="document-modal-body">
                    <!-- 详情内容会动态填充 -->
                </div>
                <div class="modal-footer">
                    <div id="document-action-buttons"></div>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 更新进度与内容模态框 -->
    <div class="modal fade" id="updateDocumentModal" tabindex="-1" role="dialog" aria-labelledby="updateDocumentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateDocumentModalLabel">更新文书内容与进度</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="document-form">
                        <div class="mb-3">
                            <label for="document-progress" class="form-label">润色进度 (%)</label>
                            <input type="range" class="form-range" min="0" max="100" step="5" id="document-progress">
                            <div class="row">
                                <div class="col-md-6"><span id="progress-value">50</span>%</div>
                                <div class="col-md-6 text-right">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setProgress(25)">25%</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setProgress(50)">50%</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setProgress(75)">75%</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setProgress(100)">100%</button>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="document-content" class="form-label">润色后内容</label>
                            <textarea class="form-control" id="document-content" rows="15" placeholder="请输入润色后的文书内容"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="document-comments" class="form-label">润色说明/点评（选填）</label>
                            <textarea class="form-control" id="document-comments" rows="3" placeholder="请输入润色说明或对学生文书的点评"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submit-document-btn">提交</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../../js/common.js"></script>
    <script>
        let currentDocumentId = null;
        
        // 检查登录状态
        checkLogin();
        
        // 退出登录
        document.getElementById('logout-btn').addEventListener('click', () => {
            logout();
            window.location.href = '../../index.html';
        });
        
        // 加载文书预约列表
        async function loadDocumentList() {
            try {
                // 获取筛选条件
                const statusFilter = document.getElementById('document-status-filter').value;
                const studentNameFilter = document.getElementById('document-student-filter').value;
                const documentTypeFilter = document.getElementById('document-type-filter').value;
                
                // 构建查询参数
                const params = new URLSearchParams();
                if (statusFilter) params.append('status', statusFilter);
                if (studentNameFilter) params.append('student_name', studentNameFilter);
                if (documentTypeFilter) params.append('document_type', documentTypeFilter);
                
                const response = await apiClient.get(`/teacher/document/list?${params.toString()}`);
                const documents = response.data;
                
                const container = document.getElementById('document-list-container');
                
                if (documents.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <p class="text-muted">暂无文书预约记录</p>
                        </div>
                    `;
                    return;
                }
                
                // 生成文书列表HTML
                let html = `
                    <table class="table table-bordered table-hover">
                        <thead class="thead-light">
                            <tr>
                                <th>文书编号</th>
                                <th>学生</th>
                                <th>文书类型</th>
                                <th>润色篇数</th>
                                <th>预约时间</th>
                                <th>状态</th>
                                <th>进度</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                documents.forEach(doc => {
                    // 状态样式
                    let statusClass = 'badge-secondary';
                    let statusText = '未知';
                    
                    switch(doc.status) {
                        case 'pending':
                            statusClass = 'badge-warning';
                            statusText = '待受理';
                            break;
                        case 'accepted':
                            statusClass = 'badge-info';
                            statusText = '已受理';
                            break;
                        case 'processing':
                            statusClass = 'badge-primary';
                            statusText = '处理中';
                            break;
                        case 'completed':
                            statusClass = 'badge-success';
                            statusText = '已完成';
                            break;
                        case 'rejected':
                            statusClass = 'badge-danger';
                            statusText = '已拒绝';
                            break;
                    }
                    
                    // 进度条
                    const progress = doc.progress || 0;
                    const progressBar = `
                        <div class="progress progress-sm">
                            <div class="progress-bar ${getProgressBarClass(progress)}" role="progressbar" style="width: ${progress}%" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100">
                                ${progress}%
                            </div>
                        </div>
                    `;
                    
                    html += `
                        <tr>
                            <td>${doc.id}</td>
                            <td>${doc.student_name}</td>
                            <td>${getDocumentTypeText(doc.document_type)}</td>
                            <td>${doc.document_count}篇</td>
                            <td>${formatDate(doc.created_at)}</td>
                            <td><span class="badge ${statusClass}">${statusText}</span></td>
                            <td>${doc.status !== 'rejected' ? progressBar : '-'}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="viewDocumentDetail(${doc.id})")>
                                    查看详情
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                container.innerHTML = html;
            } catch (error) {
                console.error('获取文书预约列表失败:', error);
                document.getElementById('document-list-container').innerHTML = `
                    <div class="text-center py-5">
                        <p class="text-danger">加载文书预约记录失败，请稍后重试</p>
                    </div>
                `;
            }
        }
        
        // 查看文书预约详情
        async function viewDocumentDetail(documentId) {
            try {
                const response = await apiClient.get(`/teacher/document/detail?id=${documentId}`);
                const documentData = response.data;
                currentDocumentId = documentId;
                
                // 生成详情HTML
                const modalBody = document.getElementById('document-modal-body');
                
                // 进度条
                const progress = documentData.progress || 0;
                const progressBar = `
                    <div class="progress">
                        <div class="progress-bar ${getProgressBarClass(progress)}" role="progressbar" style="width: ${progress}%" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100">
                            ${progress}%
                        </div>
                    </div>
                `;
                
                modalBody.innerHTML = `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>文书编号：</strong>${documentData.id}</p>
                            <p><strong>学生：</strong>${documentData.student_name}</p>
                            <p><strong>文书类型：</strong>${getDocumentTypeText(documentData.document_type)}</p>
                            <p><strong>润色篇数：</strong>${documentData.document_count}篇</p>
                            <p><strong>目标学校：</strong>${documentData.target_school || '未指定'}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>预约时间：</strong>${formatDate(documentData.created_at)}</p>
                            <p><strong>状态：</strong>${getStatusText(documentData.status)}</p>
                            <p><strong>进度：</strong>${documentData.status !== 'rejected' ? progressBar : '-'}</p>
                        </div>
                    </div>
                    ${documentData.notes ? `<div class="mb-3"><strong>备注：</strong>${documentData.notes}</div>` : ''}
                    ${documentData.revised_content ? `
                        <div class="mb-3">
                            <strong>润色后内容：</strong>
                            <div class="mt-2 p-3 bg-light border rounded" style="white-space: pre-wrap;">
                                ${documentData.revised_content}
                            </div>
                        </div>
                    ` : ''}
                    ${documentData.comments ? `<div class="mb-3"><strong>润色说明：</strong>${documentData.comments}</div>` : ''}
                    ${documentData.reject_reason ? `
                        <div class="mb-3">
                            <strong>拒绝原因：</strong>
                            <div class="mt-2 p-3 bg-light border rounded">
                                ${documentData.reject_reason}
                            </div>
                        </div>
                    ` : ''}
                `;
                
                // 生成操作按钮
                const actionButtons = document.getElementById('document-action-buttons');
                actionButtons.innerHTML = '';
                
                // 根据状态显示不同按钮
                if (document.status === 'pending') {
                    // 待受理状态：显示接受和拒绝按钮
                    actionButtons.innerHTML = `
                        <button type="button" class="btn btn-success mr-2" onclick="acceptDocument(${documentId})")>
                            接受预约
                        </button>
                        <button type="button" class="btn btn-danger mr-2" onclick="rejectDocument(${documentId})")>
                            拒绝预约
                        </button>
                    `;
                } else if (document.status === 'accepted' || document.status === 'processing') {
                    // 已受理或处理中：显示更新内容按钮
                    actionButtons.innerHTML = `
                        <button type="button" class="btn btn-primary mr-2" data-dismiss="modal" onclick="prepareDocumentUpdate(${documentId}, ${document.progress || 0}, '${escapeHtml(document.content || '')}', '${escapeHtml(document.comments || '')}')">
                            更新内容
                        </button>
                        ${document.status === 'accepted' ? `
                            <button type="button" class="btn btn-warning mr-2" onclick="startDocument(${documentId})")>
                                开始处理
                            </button>
                        ` : ''}
                    `;
                }
                
                // 显示模态框（使用原生JavaScript替代jQuery）
                const modal = new bootstrap.Modal(document.getElementById('documentDetailModal'));
                modal.show();
            } catch (error) {
                console.error('获取文书预约详情失败:', error);
                alert('加载详情失败，请稍后重试');
            }
        }
        
        // 接受文书预约
        async function acceptDocument(documentId) {
            if (!confirm('确定接受该文书预约吗？')) return;
            
            try {
                await apiClient.put('/teacher/document/status', {
                    id: documentId,
                    status: 'accepted'
                });
                alert('文书预约已接受');
                // 隐藏模态框（使用原生JavaScript替代jQuery）
                const modal = bootstrap.Modal.getInstance(document.getElementById('documentDetailModal'));
                modal.hide();
                loadDocumentList();
            } catch (error) {
                console.error('接受文书预约失败:', error);
                alert('操作失败，请稍后重试');
            }
        }
        
        // 拒绝文书预约
        async function rejectDocument(documentId) {
            const reason = prompt('请输入拒绝原因：');
            if (!reason) return;
            
            try {
                await apiClient.put('/teacher/document/status', {
                    id: documentId,
                    status: 'rejected',
                    reject_reason: reason
                });
                alert('文书预约已拒绝');
                $('#documentDetailModal').modal('hide');
                loadDocumentList();
            } catch (error) {
                console.error('拒绝文书预约失败:', error);
                alert('操作失败，请稍后重试');
            }
        }
        
        // 开始处理文书
        async function startDocument(documentId) {
            if (!confirm('确定开始处理该文书吗？')) return;
            
            try {
                await apiClient.put('/teacher/document/progress', {
                    id: documentId,
                    status: 'processing'
                });
                alert('已开始处理文书');
                $('#documentDetailModal').modal('hide');
                loadDocumentList();
            } catch (error) {
                console.error('开始处理文书失败:', error);
                alert('操作失败，请稍后重试');
            }
        }
        
        // 准备更新文书内容
        function prepareDocumentUpdate(documentId, currentProgress, content, comments) {
            currentDocumentId = documentId;
            const progressInput = document.getElementById('document-progress');
            progressInput.value = currentProgress;
            document.getElementById('progress-value').textContent = currentProgress;
            document.getElementById('document-content').value = unescapeHtml(content);
            document.getElementById('document-comments').value = unescapeHtml(comments);
            // 显示更新文档模态框（使用原生JavaScript替代jQuery）
            const modal = new bootstrap.Modal(document.getElementById('updateDocumentModal'));
            modal.show();
        }
        
        // 提交文书更新
        document.getElementById('submit-document-btn').addEventListener('click', async () => {
            const progress = document.getElementById('document-progress').value;
            const content = document.getElementById('document-content').value;
            const comments = document.getElementById('document-comments').value;
            
            if (!content.trim()) {
                alert('请输入润色后的文书内容');
                return;
            }
            
            try {
                // 确定状态
                let status = 'processing';
                if (parseInt(progress) >= 100) {
                    status = 'completed';
                }
                
                await apiClient.put('/teacher/document/content', {
                    id: currentDocumentId,
                    progress: parseInt(progress),
                    content: content,
                    comments: comments,
                    status: status
                });
                
                alert('文书内容更新成功');
                // 隐藏模态框（使用原生JavaScript替代jQuery）
                const modal = bootstrap.Modal.getInstance(document.getElementById('updateDocumentModal'));
                modal.hide();
                loadDocumentList();
            } catch (error) {
                console.error('更新文书内容失败:', error);
                alert('更新失败，请稍后重试');
            }
        });
        
        // 进度条事件
        document.getElementById('document-progress').addEventListener('input', (e) => {
            document.getElementById('progress-value').textContent = e.target.value;
        });
        
        // 设置进度
        function setProgress(value) {
            document.getElementById('document-progress').value = value;
            document.getElementById('progress-value').textContent = value;
        }
        
        // 筛选按钮点击事件
        document.getElementById('document-filter-btn').addEventListener('click', loadDocumentList);
        
        // 重置筛选按钮点击事件
        document.getElementById('document-reset-filter-btn').addEventListener('click', () => {
            document.getElementById('document-status-filter').value = '';
            document.getElementById('document-student-filter').value = '';
            document.getElementById('document-type-filter').value = '';
            loadDocumentList();
        });
        
        // 辅助函数：获取文书类型文本
        function getDocumentTypeText(type) {
            const types = {
                'personal_statement': '个人陈述(PS)',
                'sop': '目的陈述(SOP)',
                'letter_of_recommendation': '推荐信',
                'cv': '简历',
                'essay': '小作文',
                'other': '其他'
            };
            return types[type] || type;
        }
        
        // 辅助函数：获取状态文本
        function getStatusText(status) {
            const statuses = {
                'pending': '待受理',
                'accepted': '已受理',
                'processing': '处理中',
                'completed': '已完成',
                'rejected': '已拒绝'
            };
            return statuses[status] || '未知';
        }
        
        // 辅助函数：获取进度条样式类
        function getProgressBarClass(progress) {
            if (progress < 30) return 'bg-danger';
            if (progress < 70) return 'bg-warning';
            return 'bg-success';
        }
        
        // 辅助函数：格式化日期
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }
        
        // 辅助函数：转义HTML
        function escapeHtml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        // 辅助函数：反转义HTML
        function unescapeHtml(text) {
            return text
                .replace(/&amp;/g, '&')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&quot;/g, '"')
                .replace(/&#039;/g, '\'');
        }
        
        // 页面加载时初始化
        window.addEventListener('DOMContentLoaded', () => {
            // 检查登录状态
            if (!checkLogin()) return;
            
            // 检查角色权限
            const role = getUserRole();
            if (role !== 'teacher') {
                alert('您没有权限访问此页面');
                window.location.href = '../../index.html';
                return;
            }
            
            // 设置用户名显示
            const username = getUsername();
            if (username) {
                document.getElementById('username-display').textContent = username;
            }
            
            // 加载数据
            loadDocumentList();
        });
    </script>
</body>
</html>