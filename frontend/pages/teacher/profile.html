<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人信息 - 留学服务平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/style.css">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="../../index.html">留学服务平台</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">仪表盘</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="statistics.html">学生统计</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="training-management.html">培训管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="document-management.html">文书管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="school-management.html">学校管理</a>
                    </li>
                </ul>
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span id="username-display">用户名</span>
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item active" href="profile.html">个人信息</a>
                            <a class="dropdown-item" href="javascript:void(0);" id="logout-btn">退出登录</a>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主体内容 -->
    <div class="container mt-5">
        <h2>个人信息</h2>
        
        <div class="row mt-5">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4>基本信息</h4>
                    </div>
                    <div class="card-body">
                        <form id="profile-form">
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label for="username">用户名</label>
                                    <input type="text" class="form-control" id="username" readonly>
                                </div>
                                
                                <div class="form-group col-md-6">
                                    <label for="role">用户角色</label>
                                    <input type="text" class="form-control" id="role" value="教师" readonly>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="name">姓名</label>
                                <input type="text" class="form-control" id="name" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label for="email">邮箱</label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                                
                                <div class="form-group col-md-6">
                                    <label for="phone">电话</label>
                                    <input type="tel" class="form-control" id="phone" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="subject">擅长科目</label>
                                <input type="text" class="form-control" id="subject" placeholder="如：英语写作、数学、计算机等">
                            </div>
                            
                            <button type="submit" class="btn btn-primary mt-4">保存修改</button>
                        </form>
                    </div>
                </div>
                
                <!-- 修改密码 -->
                <div class="card mt-5">
                    <div class="card-header bg-secondary text-white">
                        <h4>修改密码</h4>
                    </div>
                    <div class="card-body">
                        <form id="password-form">
                            <div class="form-group">
                                <label for="current-password">当前密码</label>
                                <input type="password" class="form-control" id="current-password" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="new-password">新密码</label>
                                <input type="password" class="form-control" id="new-password" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="confirm-password">确认新密码</label>
                                <input type="password" class="form-control" id="confirm-password" required>
                            </div>
                            
                            <button type="submit" class="btn btn-secondary mt-4">修改密码</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../../js/common.js"></script>
    <script>
        // 检查登录状态
        checkLogin();
        
        // 退出登录
        document.getElementById('logout-btn').addEventListener('click', () => {
            logout();
            window.location.href = '../../index.html';
        });
        
        // 加载个人信息
        async function loadProfile() {
            try {
                const response = await apiClient.get('/teacher/profile');
                const profile = response.data;
                
                // 填充表单数据
                document.getElementById('username').value = profile.username || '';
                document.getElementById('name').value = profile.name || '';
                document.getElementById('email').value = profile.email || '';
                document.getElementById('phone').value = profile.phone || '';
                document.getElementById('subject').value = profile.subject || '';
                
                // 更新用户名显示
                document.getElementById('username-display').textContent = profile.username || '用户名';
            } catch (error) {
                console.error('获取个人信息失败:', error);
            }
        }
        
        // 提交个人信息修改
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const profileData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                subject: document.getElementById('subject').value
            };
            
            try {
                const response = await apiClient.put('/teacher/profile', profileData);
                alert('个人信息更新成功！');
            } catch (error) {
                console.error('更新个人信息失败:', error);
                alert('更新失败，请稍后重试。');
            }
        });
        
        // 修改密码
        document.getElementById('password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (newPassword !== confirmPassword) {
                alert('新密码和确认密码不匹配！');
                return;
            }
            
            try {
                // 这里使用一个通用的密码修改接口
                const response = await apiClient.put('/teacher/profile', {
                    current_password: currentPassword,
                    new_password: newPassword
                });
                
                alert('密码修改成功！');
                // 清空密码表单
                document.getElementById('password-form').reset();
            } catch (error) {
                console.error('修改密码失败:', error);
                alert('修改失败，请检查当前密码是否正确。');
            }
        });
        
        // 页面加载时初始化
        window.addEventListener('DOMContentLoaded', () => {
            // 检查登录状态
            if (!checkLogin()) return;
            
            // 检查角色权限
            const role = getUserRole();
            if (role !== 'teacher') {
                alert('您没有权限访问此页面');
                window.location.href = '../../index.html';
                return;
            }
            
            // 加载个人信息
            loadProfile();
        });
    </script>
</body>
</html>