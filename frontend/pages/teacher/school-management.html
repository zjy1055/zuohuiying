<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学校管理 - 留学服务平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/style.css">
    <style>
        .action-buttons button {
            margin-right: 5px;
        }
        .pagination {
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="../../index.html">留学服务平台</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">仪表盘</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="training-management.html">培训管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="document-management.html">文书管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="student-statistics.html">学生统计</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="school-management.html">学校管理</a>
                    </li>
                </ul>
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span id="username-display">用户名</span>
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="profile.html">个人信息</a>
                            <a class="dropdown-item" href="javascript:void(0);" id="logout-btn">退出登录</a>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主体内容 -->
    <div class="container mt-5">
        <h2>学校信息管理</h2>
        <p class="text-muted mb-4">管理平台收录的所有学校信息</p>
        
        <!-- 操作栏 -->
        <div class="mb-4 d-flex justify-content-between align-items-center">
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addSchoolModal">
                <i class="fas fa-plus"></i> 新增学校
            </button>
            
            <!-- 搜索框 -->
            <div class="input-group" style="width: 300px;">
                <input type="text" class="form-control" placeholder="搜索学校名称" id="school-search-input">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" id="school-search-btn">搜索</button>
                </div>
            </div>
        </div>
        
        <!-- 学校列表 -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4>学校列表</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="thead-light">
                            <tr>
                                <th>序号</th>
                                <th>学校中文名</th>
                                <th>学校英文名</th>
                                <th>地理位置</th>
                                <th>综合排名</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="school-list-body">
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="sr-only">加载中...</span>
                                    </div>
                                    <span class="ml-2">正在加载学校信息...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页控件 -->
                <div class="mt-4">
                    <nav aria-label="Page navigation example">
                        <ul class="pagination" id="pagination-controls">
                            <!-- 分页控件将动态生成 -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增学校模态框 -->
    <div class="modal fade" id="addSchoolModal" tabindex="-1" role="dialog" aria-labelledby="addSchoolModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSchoolModalLabel">新增学校</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="add-school-form">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="school-cname" class="form-label">学校中文名 *</label>
                                <input type="text" class="form-control" id="school-cname" required>
                            </div>
                            <div class="col-md-6">
                                <label for="school-ename" class="form-label">学校英文名 *</label>
                                <input type="text" class="form-control" id="school-ename" required>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="school-location" class="form-label">地理位置 *</label>
                                <input type="text" class="form-control" id="school-location" required placeholder="例如：美国-加州">
                            </div>
                            <div class="col-md-6">
                                <label for="school-ranking" class="form-label">综合排名 *</label>
                                <input type="number" class="form-control" id="school-ranking" required min="1">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="school-intro" class="form-label">基本介绍</label>
                            <textarea class="form-control" id="school-intro" rows="3"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="school-major-rankings" class="form-label">专业排名</label>
                            <textarea class="form-control" id="school-major-rankings" rows="2" placeholder="例如：计算机：10；商科：20；工程：15"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="school-details" class="form-label">详细信息</label>
                            <textarea class="form-control" id="school-details" rows="4" placeholder="学费、申请要求等详细信息"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submit-add-school">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑学校模态框 -->
    <div class="modal fade" id="editSchoolModal" tabindex="-1" role="dialog" aria-labelledby="editSchoolModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editSchoolModalLabel">编辑学校信息</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="edit-school-form">
                        <input type="hidden" id="edit-school-id">
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="edit-school-cname" class="form-label">学校中文名 *</label>
                                <input type="text" class="form-control" id="edit-school-cname" required>
                            </div>
                            <div class="col-md-6">
                                <label for="edit-school-ename" class="form-label">学校英文名 *</label>
                                <input type="text" class="form-control" id="edit-school-ename" required>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="edit-school-location" class="form-label">地理位置 *</label>
                                <input type="text" class="form-control" id="edit-school-location" required placeholder="例如：美国-加州">
                            </div>
                            <div class="col-md-6">
                                <label for="edit-school-ranking" class="form-label">综合排名 *</label>
                                <input type="number" class="form-control" id="edit-school-ranking" required min="1">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-school-intro" class="form-label">基本介绍</label>
                            <textarea class="form-control" id="edit-school-intro" rows="3"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-school-major-rankings" class="form-label">专业排名</label>
                            <textarea class="form-control" id="edit-school-major-rankings" rows="2" placeholder="例如：计算机：10；商科：20；工程：15"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-school-details" class="form-label">详细信息</label>
                            <textarea class="form-control" id="edit-school-details" rows="4" placeholder="学费、申请要求等详细信息"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submit-edit-school">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../../js/common.js"></script>
    <script>
        // 全局变量
        let currentPage = 1;
        const pageSize = 10;
        let totalPages = 1;
        let currentSearchTerm = '';
        
        // 检查登录状态
        checkLogin();
        
        // 退出登录
        document.getElementById('logout-btn').addEventListener('click', () => {
            logout();
            window.location.href = '../../index.html';
        });
        
        // 加载学校列表
        async function loadSchoolList(page = 1, searchTerm = '') {
            try {
                // 构建查询参数
                const params = new URLSearchParams();
                params.append('page', page);
                params.append('page_size', pageSize);
                if (searchTerm) {
                    params.append('search', searchTerm);
                }
                
                const response = await apiClient.get(`/teacher/school/list?${params.toString()}`);
                const data = response.data;
                
                // 更新全局变量
                currentPage = page;
                totalPages = data.total_pages;
                currentSearchTerm = searchTerm;
                
                // 更新学校列表
                updateSchoolList(data.schools);
                
                // 更新分页控件
                updatePagination();
            } catch (error) {
                console.error('加载学校列表失败:', error);
                showErrorMessage('加载学校列表失败，请稍后重试');
            }
        }
        
        // 更新学校列表
        function updateSchoolList(schools) {
            const tableBody = document.getElementById('school-list-body');
            
            // 添加防御性检查，确保schools是数组
            if (!schools || schools.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            ${currentSearchTerm ? '没有找到匹配的学校' : '暂无学校信息'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            schools.forEach((school, index) => {
                const serialNumber = (currentPage - 1) * pageSize + index + 1;
                html += `
                    <tr>
                        <td>${serialNumber}</td>
                        <td>${school.chinese_name}</td>
                        <td>${school.english_name}</td>
                        <td>${school.location}</td>
                        <td>${school.ranking}</td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-warning" onclick="editSchool(${school.id})">
                                编辑
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSchool(${school.id}, '${school.chinese_name}')">
                                删除
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }
        
        // 更新分页控件
        function updatePagination() {
            const paginationContainer = document.getElementById('pagination-controls');
            
            let html = '';
            
            // 上一页按钮
            html += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="javascript:void(0);" onclick="loadSchoolList(${currentPage - 1}, '${currentSearchTerm}')">上一页</a>
                </li>
            `;
            
            // 页码按钮 - 简单分页逻辑，显示当前页附近的页码
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, startPage + 4);
            
            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="javascript:void(0);" onclick="loadSchoolList(${i}, '${currentSearchTerm}')">${i}</a>
                    </li>
                `;
            }
            
            // 下一页按钮
            html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="javascript:void(0);" onclick="loadSchoolList(${currentPage + 1}, '${currentSearchTerm}')">下一页</a>
                </li>
            `;
            
            paginationContainer.innerHTML = html;
        }
        
        // 编辑学校
        async function editSchool(schoolId) {
            try {
                // 获取学校详细信息
                const response = await apiClient.get(`/teacher/school/detail?school_id=${schoolId}`);
                const school = response.data;
                
                // 填充表单
                document.getElementById('edit-school-id').value = school.id;
                document.getElementById('edit-school-cname').value = school.chinese_name;
                document.getElementById('edit-school-ename').value = school.english_name;
                document.getElementById('edit-school-location').value = school.location;
                document.getElementById('edit-school-ranking').value = school.ranking;
                document.getElementById('edit-school-intro').value = school.introduction || '';
                document.getElementById('edit-school-major-rankings').value = school.major_rankings || '';
                document.getElementById('edit-school-details').value = school.details || '';
                
                // 显示编辑学校模态框（使用原生JavaScript替代jQuery）
                const modal = new bootstrap.Modal(document.getElementById('editSchoolModal'));
                modal.show();
            } catch (error) {
                console.error('获取学校信息失败:', error);
                alert('加载学校信息失败，请稍后重试');
            }
        }
        
        // 删除学校
        async function deleteSchool(schoolId, schoolName) {
            if (!confirm(`确定要删除学校"${schoolName}"吗？此操作不可恢复。`)) {
                return;
            }
            
            try {
                await apiClient.delete(`/teacher/school/delete?school_id=${schoolId}`);
                alert('学校删除成功');
                // 重新加载当前页数据
                loadSchoolList(currentPage, currentSearchTerm);
            } catch (error) {
                console.error('删除学校失败:', error);
                alert('删除失败，请稍后重试');
            }
        }
        
        // 提交新增学校表单
        document.getElementById('submit-add-school').addEventListener('click', async () => {
            // 表单验证
            const form = document.getElementById('add-school-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            try {
                // 收集表单数据
                const schoolData = {
                    chinese_name: document.getElementById('school-cname').value,
                    english_name: document.getElementById('school-ename').value,
                    location: document.getElementById('school-location').value,
                    ranking: parseInt(document.getElementById('school-ranking').value),
                    introduction: document.getElementById('school-intro').value,
                    major_rankings: document.getElementById('school-major-rankings').value,
                    details: document.getElementById('school-details').value
                };
                
                // 提交请求
                await apiClient.post('/teacher/school/add', schoolData);
                
                alert('学校添加成功');
                // 使用原生JavaScript替代jQuery关闭模态框
                const addModal = bootstrap.Modal.getInstance(document.getElementById('addSchoolModal'));
                addModal.hide();
                form.reset();
                
                // 重新加载数据，跳转到第一页
                loadSchoolList(1, currentSearchTerm);
            } catch (error) {
                console.error('添加学校失败:', error);
                alert('添加失败，请稍后重试');
            }
        });
        
        // 提交编辑学校表单
        document.getElementById('submit-edit-school').addEventListener('click', async () => {
            // 表单验证
            const form = document.getElementById('edit-school-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            try {
                const schoolId = document.getElementById('edit-school-id').value;
                
                // 收集表单数据
                const schoolData = {
                    school_id: schoolId,
                    chinese_name: document.getElementById('edit-school-cname').value,
                    english_name: document.getElementById('edit-school-ename').value,
                    location: document.getElementById('edit-school-location').value,
                    ranking: parseInt(document.getElementById('edit-school-ranking').value),
                    introduction: document.getElementById('edit-school-intro').value,
                    major_rankings: document.getElementById('edit-school-major-rankings').value,
                    details: document.getElementById('edit-school-details').value
                };
                
                // 提交请求
                await apiClient.put(`/teacher/school/edit?school_id=${schoolId}`, schoolData);
                
                alert('学校信息更新成功');
                // 使用原生JavaScript替代jQuery关闭模态框
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editSchoolModal'));
                editModal.hide();
                
                // 重新加载当前页数据
                loadSchoolList(currentPage, currentSearchTerm);
            } catch (error) {
                console.error('更新学校信息失败:', error);
                alert('更新失败，请稍后重试');
            }
        });
        
        // 搜索功能
        document.getElementById('school-search-btn').addEventListener('click', () => {
            const searchTerm = document.getElementById('school-search-input').value.trim();
            loadSchoolList(1, searchTerm);
        });
        
        // 回车键触发搜索
        document.getElementById('school-search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('school-search-btn').click();
            }
        });
        
        // 显示错误信息
        function showErrorMessage(message) {
            const container = document.querySelector('.container');
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show';
            alert.role = 'alert';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove();" aria-label="Close"></button>
            `;
            container.prepend(alert);
            
            // 3秒后自动关闭
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => {
                    alert.remove();
                }, 150);
            }, 3000);
        }
        
        // 页面加载时初始化
        window.addEventListener('DOMContentLoaded', () => {
            // 检查登录状态
            if (!checkLogin()) return;
            
            // 检查角色权限
            const role = getUserRole();
            if (role !== 'teacher') {
                alert('您没有权限访问此页面');
                window.location.href = '../../index.html';
                return;
            }
            
            // 设置用户名显示
            const username = getUsername();
            if (username) {
                document.getElementById('username-display').textContent = username;
            }
            
            // 加载学校列表
            loadSchoolList();
        });
    </script>
</body>
</html>