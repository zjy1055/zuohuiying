<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学生统计 - 留学服务平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/style.css">
    <style>
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .stat-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="../../index.html">留学服务平台</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">仪表盘</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="training-management.html">培训管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="document-management.html">文书管理</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="student-statistics.html">学生统计</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="school-management.html">学校管理</a>
                    </li>
                </ul>
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span id="username-display">用户名</span>
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="profile.html">个人信息</a>
                            <a class="dropdown-item" href="javascript:void(0);" id="logout-btn">退出登录</a>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主体内容 -->
    <div class="container mt-5">
        <h2>学生数据统计</h2>
        <p class="text-muted mb-5">查看平台学生相关数据统计与分析</p>
        
        <!-- 统计卡片 -->
        <div class="row mb-5">
            <div class="col-md-3">
                <div class="card stat-card bg-info text-white">
                    <div class="card-body">
                        <h5 class="card-title">学生总数</h5>
                        <p class="card-text" id="total-students">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">平均托福分数</h5>
                        <p class="card-text" id="avg-toefl">0.0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-warning text-white">
                    <div class="card-body">
                        <h5 class="card-title">平均GRE分数</h5>
                        <p class="card-text" id="avg-gre">0.0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-danger text-white">
                    <div class="card-body">
                        <h5 class="card-title">平均GPA</h5>
                        <p class="card-text" id="avg-gpa">0.0</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 图表区域 -->
        <div class="row mb-5">
            <!-- 性别比例图表 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4>学生性别比例</h4>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="genderChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 目标地区分布图表 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4>目标地区分布</h4>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="regionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 分数分布图表 -->
        <div class="row mb-5">
            <!-- 托福分数分布 -->
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4>托福分数分布</h4>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="toeflChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 详细统计表格 -->
        <div class="card mb-5">
            <div class="card-header bg-primary text-white">
                <h4>详细数据统计</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="thead-light">
                            <tr>
                                <th>统计类别</th>
                                <th>数值</th>
                                <th>说明</th>
                            </tr>
                        </thead>
                        <tbody id="statistics-table-body">
                            <!-- 动态填充详细统计数据 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 留学成功率预测 -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4>留学成功率预测</h4>
            </div>
            <div class="card-body">
                <form id="prediction-form">
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label for="toefl-min" class="form-label">托福最低分数</label>
                            <input type="number" class="form-control" id="toefl-min" placeholder="例如：80" min="0" max="120" step="1">
                        </div>
                        <div class="col-md-4">
                            <label for="gre-min" class="form-label">GRE最低分数</label>
                            <input type="number" class="form-control" id="gre-min" placeholder="例如：300" min="0" max="340" step="1">
                        </div>
                        <div class="col-md-4">
                            <label for="gpa-min" class="form-label">最低GPA</label>
                            <input type="number" class="form-control" id="gpa-min" placeholder="例如：3.0" min="0" max="4.0" step="0.1">
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label for="target-region" class="form-label">目标地区</label>
                            <select class="form-select" id="target-region">
                                <option value="">全部</option>
                                <option value="美国">美国</option>
                                <option value="英国">英国</option>
                                <option value="加拿大">加拿大</option>
                                <option value="澳大利亚">澳大利亚</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div class="col-md-8"></div>
                    </div>
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary">预测成功率</button>
                    </div>
                </form>
                
                <div id="prediction-result" class="mt-4 hidden">
                    <div class="card">
                        <div class="card-body">
                            <div class="text-center">
                                <h4>预测结果</h4>
                                <div class="prediction-success-rate">
                                    成功率预估: <span id="success-rate" class="text-primary">0%</span>
                                </div>
                                <div class="mt-3" id="prediction-details">
                                    <!-- 预测详情 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../../js/common.js"></script>
    <script>
        // 图表对象
        let genderChart, regionChart, toeflChart;
        
        // 检查登录状态
        checkLogin();
        
        // 退出登录
        document.getElementById('logout-btn').addEventListener('click', () => {
            logout();
            window.location.href = '../../index.html';
        });
        
        // 加载学生统计数据
        async function loadStudentStatistics() {
            try {
                const response = await apiClient.get('/teacher/statistics/student');
                const data = response.data;
                
                // 更新统计卡片
                document.getElementById('total-students').textContent = data.total_students || 0;
                document.getElementById('avg-toefl').textContent = (data.avg_toefl !== undefined && data.avg_toefl !== null) ? data.avg_toefl.toFixed(1) : '0.0';
                document.getElementById('avg-gre').textContent = (data.avg_gre !== undefined && data.avg_gre !== null) ? data.avg_gre.toFixed(1) : '0.0';
                document.getElementById('avg-gpa').textContent = (data.avg_gpa !== undefined && data.avg_gpa !== null) ? data.avg_gpa.toFixed(2) : '0.00';
                
                // 创建性别比例图表
                createGenderChart(data.gender_distribution);
                
                // 创建地区分布图表
                createRegionChart(data.region_distribution);
                
                // 创建托福分数分布图表
                createToeflChart(data.toefl_distribution);
                
                // 填充详细统计表格
                fillStatisticsTable(data);
            } catch (error) {
                console.error('获取学生统计数据失败:', error);
                showErrorMessage('加载统计数据失败，请稍后重试');
            }
        }
        
        // 创建性别比例图表
        function createGenderChart(genderData) {
            const ctx = document.getElementById('genderChart').getContext('2d');
            
            if (genderChart) {
                genderChart.destroy();
            }
            
            // 添加防御性检查，确保genderData及其属性存在
            const maleCount = (genderData && genderData.male !== undefined) ? genderData.male : 0;
            const femaleCount = (genderData && genderData.female !== undefined) ? genderData.female : 0;
            
            genderChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['男', '女'],
                    datasets: [{
                        data: [maleCount, femaleCount],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 99, 132, 0.7)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 创建地区分布图表
        function createRegionChart(regionData) {
            const ctx = document.getElementById('regionChart').getContext('2d');
            
            if (regionChart) {
                regionChart.destroy();
            }
            
            // 添加防御性检查，确保regionData是对象且不为空
            if (!regionData || typeof regionData !== 'object' || Object.keys(regionData).length === 0) {
                // 如果没有数据，显示空图表
                regionChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['暂无数据'],
                        datasets: [{
                            data: [1],
                            backgroundColor: ['#e0e0e0'],
                            borderColor: ['#e0e0e0'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            title: {
                                display: true,
                                text: '地区分布'
                            }
                        }
                    }
                });
                return;
            }
            
            // 准备图表数据
            const labels = Object.keys(regionData);
            const dataValues = Object.values(regionData);
            
            // 生成颜色数组
            const backgroundColors = labels.map((_, index) => {
                const hue = (index * 137) % 360; // 使用黄金角分布生成不同颜色
                return `hsla(${hue}, 70%, 60%, 0.7)`;
            });
            
            regionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 创建托福分数分布图表
        function createToeflChart(toeflData) {
            const ctx = document.getElementById('toeflChart').getContext('2d');
            
            if (toeflChart) {
                toeflChart.destroy();
            }
            
            // 添加防御性检查，确保toeflData是对象
            if (!toeflData || typeof toeflData !== 'object') {
                // 如果数据不存在，显示空图表
                toeflChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['0-60', '61-80', '81-90', '91-100', '101-110', '111-120'],
                        datasets: [{
                            label: '学生数量',
                            data: [0, 0, 0, 0, 0, 0],
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '暂无托福分数数据'
                            }
                        }
                    }
                });
                return;
            }
            
            // 准备图表数据
            const labels = ['0-60', '61-80', '81-90', '91-100', '101-110', '111-120'];
            const dataValues = [
                toeflData['0-60'] || 0,
                toeflData['61-80'] || 0,
                toeflData['81-90'] || 0,
                toeflData['91-100'] || 0,
                toeflData['101-110'] || 0,
                toeflData['111-120'] || 0
            ];
            
            toeflChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '学生数量',
                        data: dataValues,
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw || 0;
                                    return `学生数量: ${value}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 填充详细统计表格
        function fillStatisticsTable(data) {
            const tableBody = document.getElementById('statistics-table-body');
            
            tableBody.innerHTML = `
                <tr>
                    <td>学生总数</td>
                    <td>${data.total_students}</td>
                    <td>平台注册留学生总数</td>
                </tr>
                <tr>
                    <td>男生数量</td>
                    <td>${data.gender_distribution.male}</td>
                    <td>男生占比: ${calculatePercentage(data.gender_distribution.male, data.total_students)}%</td>
                </tr>
                <tr>
                    <td>女生数量</td>
                    <td>${data.gender_distribution.female}</td>
                    <td>女生占比: ${calculatePercentage(data.gender_distribution.female, data.total_students)}%</td>
                </tr>
                <tr>
                    <td>平均托福分数</td>
                    <td>${data.avg_toefl.toFixed(1)}</td>
                    <td>所有学生托福成绩的平均值</td>
                </tr>
                <tr>
                    <td>平均GRE分数</td>
                    <td>${data.avg_gre.toFixed(1)}</td>
                    <td>所有学生GRE成绩的平均值</td>
                </tr>
                <tr>
                    <td>平均GPA</td>
                    <td>${data.avg_gpa.toFixed(2)}</td>
                    <td>所有学生GPA的平均值</td>
                </tr>
                <tr>
                    <td>最高分学生</td>
                    <td>${data.top_student.name}</td>
                    <td>托福: ${data.top_student.toefl}, GRE: ${data.top_student.gre}, GPA: ${data.top_student.gpa}</td>
                </tr>
            `;
        }
        
        // 计算百分比
        function calculatePercentage(value, total) {
            if (total === 0) return 0;
            return Math.round((value / total) * 100);
        }
        
        // 显示错误信息
        function showErrorMessage(message) {
            const container = document.querySelector('.container');
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show';
            alert.role = 'alert';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-dismiss="alert" aria-label="Close"></button>
            `;
            container.prepend(alert);
            
            // 3秒后自动关闭
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => {
                    alert.remove();
                }, 150);
            }, 3000);
        }
        
        // 处理留学成功率预测表单提交
        document.getElementById('prediction-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const toeflMin = document.getElementById('toefl-min').value;
            const greMin = document.getElementById('gre-min').value;
            const gpaMin = document.getElementById('gpa-min').value;
            const targetRegion = document.getElementById('target-region').value;
            
            // 验证输入
            if (!toeflMin && !greMin && !gpaMin) {
                alert('请至少输入一个筛选条件');
                return;
            }
            
            try {
                // 构建查询参数
                const params = new URLSearchParams();
                if (toeflMin) params.append('toefl_min', toeflMin);
                if (greMin) params.append('gre_min', greMin);
                if (gpaMin) params.append('gpa_min', gpaMin);
                if (targetRegion) params.append('region', targetRegion);
                
                const response = await apiClient.get(`/teacher/statistics/predict?${params.toString()}`);
                const result = response.data;
                
                // 显示预测结果
                document.getElementById('success-rate').textContent = `${result.success_rate}%`;
                
                // 生成预测详情
                let detailsHtml = `
                    <p>总申请案例: <strong>${result.total_cases}</strong></p>
                    <p>成功案例: <strong>${result.success_cases}</strong></p>
                `;
                
                if (result.similar_cases && result.similar_cases.length > 0) {
                    detailsHtml += `<h6 class="mt-3">类似条件成功案例:</h6>
                    <ul class="text-left">`;
                    
                    result.similar_cases.slice(0, 3).forEach(caseItem => {
                        detailsHtml += `<li>托福: ${caseItem.toefl}, GRE: ${caseItem.gre}, GPA: ${caseItem.gpa}, 录取学校: ${caseItem.school_name}</li>`;
                    });
                    
                    detailsHtml += `</ul>`;
                }
                
                document.getElementById('prediction-details').innerHTML = detailsHtml;
                document.getElementById('prediction-result').classList.remove('hidden');
                
                // 滚动到结果区域
                document.getElementById('prediction-result').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('获取预测数据失败:', error);
                alert('预测失败，请稍后重试');
            }
        });
        
        // 页面加载时初始化
        window.addEventListener('DOMContentLoaded', () => {
            // 检查登录状态
            if (!checkLogin()) return;
            
            // 检查角色权限
            const role = getUserRole();
            if (role !== 'teacher') {
                alert('您没有权限访问此页面');
                window.location.href = '../../index.html';
                return;
            }
            
            // 设置用户名显示
            const username = getUsername();
            if (username) {
                document.getElementById('username-display').textContent = username;
            }
            
            // 加载统计数据
            loadStudentStatistics();
        });
    </script>
</body>
</html>