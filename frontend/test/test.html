<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API测试页面 - 留学服务平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
        }
        .header {
            background-color: #0d6efd;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        .test-options {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .result-section {
            margin-top: 30px;
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .loading-content {
            text-align: center;
        }
        .test-case-card {
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .test-case-card.success {
            border-left: 4px solid #198754;
        }
        .test-case-card.failure {
            border-left: 4px solid #dc3545;
        }
        .test-case-card.warning {
            border-left: 4px solid #ffc107;
        }
        .test-case-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
        }
        .log-output {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <h1 class="text-center">留学服务平台 - API测试工具</h1>
                    <p class="text-center text-white-75">用于测试前端与后端API的交互功能</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="test-options">
            <h3>测试选项</h3>
            <div class="mb-3">
                <label for="api-base-url" class="form-label">API基础URL</label>
                <input type="text" class="form-control" id="api-base-url" value="http://localhost:8000" placeholder="输入API基础URL">
            </div>
            
            <div class="mb-3">
                <label class="form-label">选择测试模式</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="testMode" id="quick-test" checked>
                    <label class="form-check-label" for="quick-test">
                        快速测试（基本功能验证）
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="testMode" id="full-test">
                    <label class="form-check-label" for="full-test">
                        完整测试（所有API功能）
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="testMode" id="custom-test">
                    <label class="form-check-label" for="custom-test">
                        自定义测试
                    </label>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">选择角色</label>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="test-teacher" checked>
                    <label class="form-check-label" for="test-teacher">教师</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="test-student" checked>
                    <label class="form-check-label" for="test-student">留学生</label>
                </div>
            </div>
            
            <button id="run-tests-btn" class="btn btn-primary btn-lg">
                <i class="fas fa-play"></i> 开始测试
            </button>
            <button id="clear-results-btn" class="btn btn-secondary btn-lg ms-2">
                <i class="fas fa-trash"></i> 清空结果
            </button>
        </div>
        
        <div class="result-section">
            <h3>测试结果</h3>
            <div id="results-summary" class="mb-4 d-none">
                <div class="card">
                    <div class="card-header">
                        <h4>测试总结</h4>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="h5">总测试数</div>
                                <div class="display-4 font-weight-bold" id="total-tests">0</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h5">通过测试</div>
                                <div class="display-4 font-weight-bold text-success" id="passed-tests">0</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h5">失败测试</div>
                                <div class="display-4 font-weight-bold text-danger" id="failed-tests">0</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h5">通过率</div>
                                <div class="display-4 font-weight-bold" id="pass-rate">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="test-cases-results">
                <!-- 测试结果将在这里动态显示 -->
                <div class="text-center text-muted py-5">
                    点击开始测试按钮运行API测试
                </div>
            </div>
        </div>
    </div>

    <!-- 加载覆盖层 -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status">
                <span class="sr-only">测试中...</span>
            </div>
            <p class="mt-3">正在执行API测试，请稍候...</p>
            <div class="mt-3" id="loading-status">准备测试环境...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="api-test.js"></script>
    <script>
        // 自定义测试用例
        const customTestCases = [
            {
                id: 'login-student',
                name: '留学生登录功能',
                description: '验证留学生用户登录API是否正常工作',
                endpoint: '/auth/login',
                method: 'POST',
                data: {
                    username: 'test_student',
                    password: 'test123',
                    role: 'student'
                },
                expectedStatusCode: 200,
                expectedDataContains: ['token', 'user_id', 'username']
            },
            {
                id: 'login-teacher',
                name: '教师登录功能',
                description: '验证教师用户登录API是否正常工作',
                endpoint: '/auth/login',
                method: 'POST',
                data: {
                    username: 'test_teacher',
                    password: 'test123',
                    role: 'teacher'
                },
                expectedStatusCode: 200,
                expectedDataContains: ['token', 'user_id', 'username']
            },
            {
                id: 'student-profile',
                name: '获取留学生个人信息',
                description: '验证获取留学生个人信息API是否正常工作',
                endpoint: '/student/profile',
                method: 'GET',
                requiresAuth: true,
                role: 'student',
                expectedStatusCode: 200,
                expectedDataContains: ['username', 'name', 'gender', 'toefl_score']
            },
            {
                id: 'teacher-profile',
                name: '获取教师个人信息',
                description: '验证获取教师个人信息API是否正常工作',
                endpoint: '/teacher/profile',
                method: 'GET',
                requiresAuth: true,
                role: 'teacher',
                expectedStatusCode: 200,
                expectedDataContains: ['username', 'name', 'email', 'phone']
            },
            {
                id: 'school-recommendation',
                name: '获取学校推荐',
                description: '验证获取学校推荐API是否正常工作',
                endpoint: '/student/recommendation',
                method: 'GET',
                requiresAuth: true,
                role: 'student',
                expectedStatusCode: 200,
                expectedDataContains: ['recommended_schools']
            },
            {
                id: 'school-search',
                name: '搜索学校功能',
                description: '验证搜索学校API是否正常工作',
                endpoint: '/student/search-schools?name=哈佛',
                method: 'GET',
                requiresAuth: true,
                role: 'student',
                expectedStatusCode: 200,
                expectedDataContains: ['schools']
            },
            {
                id: 'school-list',
                name: '获取学校列表（教师端）',
                description: '验证教师端获取学校列表API是否正常工作',
                endpoint: '/teacher/school/list?page=1&page_size=10',
                method: 'GET',
                requiresAuth: true,
                role: 'teacher',
                expectedStatusCode: 200,
                expectedDataContains: ['schools', 'total_pages']
            },
            {
                id: 'student-statistics',
                name: '获取学生统计数据',
                description: '验证获取学生统计数据API是否正常工作',
                endpoint: '/teacher/statistics/student',
                method: 'GET',
                requiresAuth: true,
                role: 'teacher',
                expectedStatusCode: 200,
                expectedDataContains: ['total_students', 'gender_ratio']
            },
            {
                id: 'training-reserve',
                name: '预约培训服务',
                description: '验证预约培训服务API是否正常工作',
                endpoint: '/student/training/reserve',
                method: 'POST',
                requiresAuth: true,
                role: 'student',
                data: {
                    teacher_id: 1,
                    hours: 10,
                    training_type: '英语培训',
                    note: '测试预约'
                },
                expectedStatusCode: 200,
                expectedDataContains: ['reservation_id']
            },
            {
                id: 'document-reserve',
                name: '预约文书服务',
                description: '验证预约文书服务API是否正常工作',
                endpoint: '/student/document/reserve',
                method: 'POST',
                requiresAuth: true,
                role: 'student',
                data: {
                    teacher_id: 1,
                    document_count: 2,
                    document_type: '个人陈述',
                    note: '测试预约'
                },
                expectedStatusCode: 200,
                expectedDataContains: ['reservation_id']
            }
        ];

        // 全局变量
        let apiBaseUrl = 'http://localhost:8000';
        let authTokens = {
            student: null,
            teacher: null
        };

        // DOM元素
        const runTestsBtn = document.getElementById('run-tests-btn');
        const clearResultsBtn = document.getElementById('clear-results-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingStatus = document.getElementById('loading-status');
        const resultsSummary = document.getElementById('results-summary');
        const testCasesResults = document.getElementById('test-cases-results');

        // 事件监听
        runTestsBtn.addEventListener('click', runTests);
        clearResultsBtn.addEventListener('click', clearResults);

        // 运行测试
        async function runTests() {
            // 显示加载覆盖层
            loadingOverlay.style.display = 'flex';
            loadingStatus.textContent = '准备测试环境...';
            
            // 清空之前的结果
            clearResults();
            
            // 获取API基础URL
            apiBaseUrl = document.getElementById('api-base-url').value.trim();
            if (!apiBaseUrl) {
                alert('请输入有效的API基础URL');
                loadingOverlay.style.display = 'none';
                return;
            }
            
            // 获取选择的测试模式
            let testMode = 'quick';
            if (document.getElementById('full-test').checked) {
                testMode = 'full';
            } else if (document.getElementById('custom-test').checked) {
                testMode = 'custom';
            }
            
            // 获取选择的角色
            const testTeacher = document.getElementById('test-teacher').checked;
            const testStudent = document.getElementById('test-student').checked;
            
            // 确定要运行的测试用例
            let testsToRun = [];
            
            if (testMode === 'quick') {
                // 快速测试 - 只测试基本的登录和个人信息获取
                if (testTeacher) {
                    testsToRun.push(customTestCases.find(t => t.id === 'login-teacher'));
                    testsToRun.push(customTestCases.find(t => t.id === 'teacher-profile'));
                }
                if (testStudent) {
                    testsToRun.push(customTestCases.find(t => t.id === 'login-student'));
                    testsToRun.push(customTestCases.find(t => t.id === 'student-profile'));
                }
            } else if (testMode === 'full') {
                // 完整测试 - 根据选择的角色运行所有相关测试
                testsToRun = customTestCases.filter(test => {
                    if (!test.requiresAuth) return true;
                    if (test.role === 'teacher' && testTeacher) return true;
                    if (test.role === 'student' && testStudent) return true;
                    return false;
                });
            } else {
                // 自定义测试（这里简化处理，实际可以让用户选择具体测试用例）
                testsToRun = customTestCases.filter(test => {
                    if (!test.requiresAuth) return true;
                    if (test.role === 'teacher' && testTeacher) return true;
                    if (test.role === 'student' && testStudent) return true;
                    return false;
                }).slice(0, 5); // 选择前5个测试
            }
            
            // 重置认证信息
            authTokens = {
                student: null,
                teacher: null
            };
            
            // 执行测试
            const results = [];
            let currentTest = 1;
            
            for (const test of testsToRun) {
                loadingStatus.textContent = `正在测试 ${test.name} (${currentTest}/${testsToRun.length})`;
                currentTest++;
                
                try {
                    // 如果需要认证，确保有相应的token
                    if (test.requiresAuth) {
                        if (!authTokens[test.role]) {
                            // 登录获取token
                            const loginTest = customTestCases.find(t => t.id === `login-${test.role}`);
                            if (loginTest) {
                                const loginResult = await executeTest(loginTest);
                                if (loginResult.passed && loginResult.responseData.token) {
                                    authTokens[test.role] = loginResult.responseData.token;
                                } else {
                                    throw new Error(`无法登录 ${test.role === 'teacher' ? '教师' : '学生'} 账号`);
                                }
                            }
                        }
                    }
                    
                    // 执行测试
                    const result = await executeTest(test);
                    results.push(result);
                    
                    // 显示测试结果
                    displayTestResult(result);
                } catch (error) {
                    console.error('测试执行失败:', error);
                    const errorResult = {
                        id: test.id,
                        name: test.name,
                        description: test.description,
                        passed: false,
                        errorMessage: error.message,
                        endpoint: test.endpoint,
                        method: test.method
                    };
                    results.push(errorResult);
                    displayTestResult(errorResult);
                }
            }
            
            // 更新总结
            updateResultsSummary(results);
            
            // 隐藏加载覆盖层
            loadingOverlay.style.display = 'none';
        }

        // 执行单个测试
        async function executeTest(test) {
            const url = `${apiBaseUrl}${test.endpoint}`;
            const options = {
                method: test.method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };
            
            // 如果需要认证，添加认证头
            if (test.requiresAuth && authTokens[test.role]) {
                options.headers['Authorization'] = `Bearer ${authTokens[test.role]}`;
            }
            
            // 添加请求体
            if (test.method === 'POST' || test.method === 'PUT') {
                options.body = JSON.stringify(test.data);
            }
            
            try {
                const startTime = Date.now();
                
                // 发送请求
                const response = await fetch(url, options);
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                let data;
                try {
                    data = await response.json();
                } catch (jsonError) {
                    data = { error: 'Invalid JSON response' };
                }
                
                // 检查状态码
                const statusCodePassed = response.status === test.expectedStatusCode;
                
                // 检查返回数据是否包含预期字段
                let fieldsPassed = true;
                let missingFields = [];
                
                if (test.expectedDataContains) {
                    for (const field of test.expectedDataContains) {
                        if (!data.hasOwnProperty(field)) {
                            fieldsPassed = false;
                            missingFields.push(field);
                        }
                    }
                }
                
                // 综合判断是否通过
                const passed = statusCodePassed && fieldsPassed;
                
                // 生成错误信息
                let errorMessage = '';
                if (!statusCodePassed) {
                    errorMessage += `预期状态码 ${test.expectedStatusCode}，实际得到 ${response.status}`;
                }
                if (!fieldsPassed) {
                    if (errorMessage) errorMessage += '; ';
                    errorMessage += `缺少预期字段: ${missingFields.join(', ')}`;
                }
                
                // 对于登录测试，保存token
                if (test.id.includes('login') && data.token) {
                    authTokens[test.role] = data.token;
                }
                
                return {
                    id: test.id,
                    name: test.name,
                    description: test.description,
                    endpoint: test.endpoint,
                    method: test.method,
                    passed,
                    errorMessage,
                    actualStatusCode: response.status,
                    responseData: data,
                    responseTime
                };
            } catch (error) {
                return {
                    id: test.id,
                    name: test.name,
                    description: test.description,
                    endpoint: test.endpoint,
                    method: test.method,
                    passed: false,
                    errorMessage: `请求失败: ${error.message}`,
                    responseData: null,
                    responseTime: 0
                };
            }
        }

        // 显示单个测试结果
        function displayTestResult(result) {
            const card = document.createElement('div');
            card.className = `card test-case-card ${result.passed ? 'success' : 'failure'}`;
            
            let html = `
                <div class="card-body">
                    <div class="test-case-header">
                        <div>
                            <h5 class="card-title mb-1">${result.name}</h5>
                            <p class="card-text text-muted mb-0">${result.description}</p>
                        </div>
                        <span class="badge status-badge ${result.passed ? 'bg-success' : 'bg-danger'}">
                            ${result.passed ? '通过' : '失败'} - ${result.responseTime}ms
                        </span>
                    </div>
                    
                    <div class="mt-3">
                        <div class="row text-sm">
                            <div class="col-md-6">
                                <strong>请求:</strong> ${result.method} ${result.endpoint}
                            </div>
                            <div class="col-md-6">
                                <strong>状态码:</strong> ${result.actualStatusCode || 'N/A'}
                            </div>
                        </div>
                    </div>
            `;
            
            if (!result.passed) {
                html += `
                    <div class="mt-3">
                        <strong>错误信息:</strong>
                        <div class="log-output mt-1">${result.errorMessage}</div>
                    </div>
                `;
            }
            
            if (result.responseData) {
                html += `
                    <div class="mt-3">
                        <strong>响应数据:</strong>
                        <div class="log-output mt-1">${JSON.stringify(result.responseData, null, 2)}</div>
                    </div>
                `;
            }
            
            html += `
                </div>
            `;
            
            card.innerHTML = html;
            testCasesResults.appendChild(card);
        }

        // 更新结果总结
        function updateResultsSummary(results) {
            const totalTests = results.length;
            const passedTests = results.filter(r => r.passed).length;
            const failedTests = totalTests - passedTests;
            const passRate = totalTests > 0 ? ((passedTests / totalTests) * 100).toFixed(2) : 0;
            
            document.getElementById('total-tests').textContent = totalTests;
            document.getElementById('passed-tests').textContent = passedTests;
            document.getElementById('failed-tests').textContent = failedTests;
            document.getElementById('pass-rate').textContent = `${passRate}%`;
            
            // 根据通过率设置颜色
            const passRateElement = document.getElementById('pass-rate');
            if (parseFloat(passRate) >= 80) {
                passRateElement.className = 'display-4 font-weight-bold text-success';
            } else if (parseFloat(passRate) >= 50) {
                passRateElement.className = 'display-4 font-weight-bold text-warning';
            } else {
                passRateElement.className = 'display-4 font-weight-bold text-danger';
            }
            
            // 显示总结
            resultsSummary.classList.remove('d-none');
        }

        // 清空结果
        function clearResults() {
            testCasesResults.innerHTML = `
                <div class="text-center text-muted py-5">
                    点击开始测试按钮运行API测试
                </div>
            `;
            resultsSummary.classList.add('d-none');
        }

        // 添加Font Awesome图标
        const fontAwesomeScript = document.createElement('script');
        fontAwesomeScript.src = 'https://kit.fontawesome.com/a076d05399.js';
        fontAwesomeScript.crossOrigin = 'anonymous';
        document.head.appendChild(fontAwesomeScript);
    </script>
</body>
</html>